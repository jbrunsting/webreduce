{% extends "feed/base.html" %}

{% block content %}
<header class="with-nav">
    <h2>Plugins</h2>
    <p><a href="/plugins">Plugin Creator</a></p>
    <p><a href="/feed/search">Plugin Search</a></p>
</header>
<ul>
    {% for subscription in subscriptions %}
    <li>
        <header class="with-nav">
            <h3>
                <a href="/plugins/view/{{ subscription.plugin_version.id }}">
                    {{ subscription.plugin_version.plugin.name }} v{{ subscription.plugin_version.major_version }}.{{ subscription.plugin_version.minor_version }}
                </a>
            </h3>
            <form class="single-button" action="/feed/unsubscribe/{{ subscription.plugin_version.id }}" method="post">
                {% csrf_token %}
                <button type="submit">Unsubscribe</button>
            </form>
            <button id="configure-{{ subscription.id }}">Configure</button>
        </header>
        <p>
            {{ subscription.plugin_version.plugin.description }}
        </p>
    </li>
    {% endfor %}
</ul>
{% if updates|length > 0 %}
<h2>Updates</h2>
<ul>
    {% for old_version, new_version in updates %}
    <li class="with-nav">
        <h3>
            {{ old_version.plugin.name }}
        </h3>
        <p>
            <a href="/plugins/view/{{ old_version.id }}">
                v{{ old_version.major_version }}.{{ old_version.minor_version }}
            </a>
            â†’
            <a href="/plugins/view/{{ new_version.id }}">
                v{{ new_version.major_version }}.{{ new_version.minor_version }}
            </a>
        </p>
        <form class="single-button" action="/feed/update/{{ new_version.id }}" method="post">
            {% csrf_token %}
            <button type="submit">Update</button>
        </form>
    </li>
    {% endfor %}
</ul>
{% endif %}
<h2>Feed</h2>
<ul id="main-feed">
    <li id="posts-loading-placeholder">
        <div class="loader"></div>
    </li>
    <li id="posts-empty-placeholder" class="start-hidden">Nothing to see here! Setup a <a href="/feed/search">new plugin</a> to get more posts</li>
</ul>
{% if divide_into_pages %}
<button id="prev-page">Previous</button>
<button id="next-page">Next</button>
{% endif %}

{% load static %}
<script src={% static "feed/configuration.js" %}></script>
<script src={% static "feed/posts.js" %}></script>
<script src={% static "modal.js" %}></script>
<script>
    var subscriptions = []

</script>
{% for subscription in subscriptions %}
<script>
    var subscription = {};

    /* beautify preserve:start */
    {% if subscription.config != "" %}
        subscription.config = {{ subscription.config|safe }};
    {% endif %}
    /* beautify preserve:end */

    (function() {
        /* beautify preserve:start */
        {{ subscription.plugin_version.code|safe }}
        /* beautify preserve:end */

        if (typeof validateConfig !== "undefined") {
            subscription.validateConfig = validateConfig;
        }

        if (typeof getConfigModal !== "undefined") {
            subscription.getConfigModal = getConfigModal;
        }

        if (typeof fetchPosts != "undefined") {
            subscription.fetchPosts = fetchPosts;
        }

        if (!subscription.getConfigModal) {
            subscription.configValid = true;
        } else if (subscription.validateConfig) {
            subscription.configValid = subscription.validateConfig(subscription.config);
        } else {
            subscription.configValid = !!subscription.config;
        }
    })();

    subscription.id = "{{ subscription.id }}";
    subscription.pluginName = "{{ subscription.plugin_version.plugin.name }}";
    subscriptions.push(subscription);

</script>
{% endfor %}
<script>
    // TODO: Move to seperate file
    var removeExistingScrollListener;

    function generatePosts() {
        var POSTS_PER_PAGE = 5;
        var POST_BUFFER = 200;
        var NUM_PLACEHOLDERS = 2;

        if (removeExistingScrollListener) {
            removeExistingScrollListener();
        }

        var postGenerator = PostGenerator();
        postGenerator.setSubscriptions(subscriptions.filter(function(subscription) {
            return subscription.configValid;
        }));

        var loadingPosts = false;
        var postList = $("#main-feed");
        var postsToRemove = postList.children().length - NUM_PLACEHOLDERS;
        postList.children().filter(":lt(" + postsToRemove + ")").remove();

        function getMorePosts(onComplete) {
            if (loadingPosts) {
                return;
            }

            loadingPosts = true;
            postGenerator.getPostsHtml(POSTS_PER_PAGE, function(posts) {
                posts.forEach(function(post) {
                    $("#posts-loading-placeholder").first().before(post);
                });

                if (!postGenerator.hasMorePosts()) {
                    $("#posts-loading-placeholder").hide();
                    if (postList.children().length == NUM_PLACEHOLDERS) {
                        $("#posts-empty-placeholder").show();
                    }
                }

                loadingPosts = false;
                onComplete();
            });
        }

        var documentNode = $(document);
        var windowNode = $(window);

        function getPostsIfRequired() {
            if (!loadingPosts && postGenerator.hasMorePosts() && documentNode.height() - documentNode.scrollTop() <= windowNode.height() + POST_BUFFER) {
                getMorePosts(getPostsIfRequired);
            }
        }

        getPostsIfRequired();

        var scrollHandler = function() {
            getPostsIfRequired();
        }

        windowNode.on("scroll", scrollHandler);

        removeExistingScrollListener = function() {
            windowNode.off("scroll", scrollHandler);
        }
    }

    function onConfig(subscription, config) {
        subscription.config = config;
        if (subscription.validateConfig) {
            subscription.configValid = subscription.validateConfig(subscription.config);
        } else {
            subscription.configValid = !!subscription.config;
        }

        generatePosts();
    }

    subscriptions.forEach(function(subscription) {
        $("#configure-" + subscription.id).click(function() {
            configure(subscription, showModal, "{{ csrf_token }}", function(config) {
                onConfig(subscription, config);
            });
        });
    });

    function GetURLParameter(param) {
        var url = window.location.search.substring(1);
        var parameters = url.split('&');
        for (var i = 0; i < parameters.length; i++) {
            var curParam = parameters[i].split('=');
            if (curParam[0] == param) {
                return curParam[1];
            }
        }
    }

    var toConfigure = GetURLParameter("configure");
    if (toConfigure) {
        subscriptions.forEach(function(subscription) {
            if (subscription.id === toConfigure) {
                configure(subscription, showModal, "{{ csrf_token }}", function(config) {
                    onConfig(subscription, config);
                });
            }
        });
    }

    generatePosts();

</script>
{% endblock %}
